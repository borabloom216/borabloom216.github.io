<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>네이버 보보 SA 광고 성과 리포트</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* 전체 폰트를 맑은 고딕으로 강제 고정 */
    body {
      font-family: 'Malgun Gothic', '맑은 고딕', sans-serif !important;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const Icons = {
      LayoutDashboard: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
      Wallet: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a8 8 0 0 1-5.45 7.49 2 2 0 0 1-2.31-1.12l-1.56-3.48a2 2 0 0 0-1.82-1.18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h15Z"/></svg>,
      TrendingUp: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
      Target: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
      PieChart: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
      Filter: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
    };

    const App = () => {
      const [rawData, setRawData] = useState([]);
      const [isLoading, setIsLoading] = useState(true);
      const [selectedCategory, setSelectedCategory] = useState('전체');
      const [pivotBy, setPivotBy] = useState('campaignType');
      const [loadError, setLoadError] = useState(false);
      
      const [monthlyBudget, setMonthlyBudget] = useState(100000000); 

      const cleanNum = (val) => {
        if (!val) return 0;
        const num = Number(val.toString().replace(/,/g, '').trim());
        return isNaN(num) ? 0 : num;
      };

      useEffect(() => {
        Papa.parse('data.csv', {
          download: true,
          header: true,
          skipEmptyLines: true,
          transformHeader: (header) => header.trim().toLowerCase(),
          complete: (results) => {
            if (results.data.length === 0) {
              setLoadError(true);
              setIsLoading(false);
              return;
            }
            
            const parsed = results.data.map((row, idx) => ({
              id: idx,
              category: row['category'] || '미분류',
              campaign: row['campaign'] || '',
              campaignType: row['campaigntype'] || row['type'] || '기타',
              device: row['device'] || '기타',
              spend: cleanNum(row['spend'] || row['ad spend']),
              clicks: cleanNum(row['clicks']),
              impressions: cleanNum(row['impressions']),
              conv: cleanNum(row['conv']),
              revenue: cleanNum(row['revenue'])
            }));
            
            setRawData(parsed);
            setIsLoading(false);
          },
          error: (err) => {
            console.error(err);
            setLoadError(true);
            setIsLoading(false);
          }
        });
      }, []);

      const categories = useMemo(() => {
        return ['전체', ...new Set(rawData.map(d => d.category))];
      }, [rawData]);

      const filteredData = useMemo(() => {
        return selectedCategory === '전체' ? rawData : rawData.filter(d => d.category === selectedCategory);
      }, [selectedCategory, rawData]);

      const totalStats = useMemo(() => {
        const totalSpend = rawData.reduce((a, b) => a + b.spend, 0);
        const totalRevenue = rawData.reduce((a, b) => a + b.revenue, 0);
        const totalClicks = rawData.reduce((a, b) => a + b.clicks, 0);
        const totalConv = rawData.reduce((a, b) => a + b.conv, 0);

        return {
          spend: totalSpend,
          revenue: totalRevenue,
          roas: totalSpend > 0 ? (totalRevenue / totalSpend) * 100 : 0,
          cvr: totalClicks > 0 ? (totalConv / totalClicks) * 100 : 0,
          burnRate: monthlyBudget > 0 ? (totalSpend / monthlyBudget) * 100 : 0
        };
      }, [rawData, monthlyBudget]);

      const stats = useMemo(() => {
        const totalSpend = filteredData.reduce((acc, curr) => acc + curr.spend, 0);
        const totalRevenue = filteredData.reduce((acc, curr) => acc + curr.revenue, 0);
        const totalClicks = filteredData.reduce((acc, curr) => acc + curr.clicks, 0);
        const totalConv = filteredData.reduce((acc, curr) => acc + curr.conv, 0);

        return { 
          totalSpend, 
          totalRevenue, 
          totalConv,
          roas: totalSpend > 0 ? (totalRevenue / totalSpend) * 100 : 0,
          cvr: totalClicks > 0 ? (totalConv / totalClicks) * 100 : 0,
        };
      }, [filteredData]);

      const pivotData = useMemo(() => {
        const groups = {};
        filteredData.forEach(item => {
          const key = item[pivotBy] || '기타';
          if (!groups[key]) {
            groups[key] = { label: key, spend: 0, revenue: 0, conv: 0, clicks: 0 };
          }
          groups[key].spend += item.spend;
          groups[key].revenue += item.revenue;
          groups[key].conv += item.conv;
          groups[key].clicks += item.clicks;
        });
        return Object.values(groups).sort((a, b) => b.spend - a.spend); 
      }, [filteredData, pivotBy]);

      const roasData = useMemo(() => {
        return categories.filter(c => c !== '전체').map(cat => {
          const cData = rawData.filter(d => d.category === cat);
          const cSpend = cData.reduce((a, b) => a + b.spend, 0);
          const cRev = cData.reduce((a, b) => a + b.revenue, 0);
          return { cat, roas: cSpend > 0 ? (cRev / cSpend) * 100 : 0 };
        }).sort((a, b) => b.roas - a.roas);
      }, [categories, rawData]);

      const cvrData = useMemo(() => {
        return categories.filter(c => c !== '전체').map(cat => {
          const cData = rawData.filter(d => d.category === cat);
          const cClicks = cData.reduce((a, b) => a + b.clicks, 0);
          const cConv = cData.reduce((a, b) => a + b.conv, 0);
          return { cat, cvr: cClicks > 0 ? (cConv / cClicks) * 100 : 0 };
        }).sort((a, b) => b.cvr - a.cvr);
      }, [categories, rawData]);

      const maxRoas = Math.max(...roasData.map(d => d.roas), 1);
      const maxCvr = Math.max(...cvrData.map(d => d.cvr), 1);

      const formatKrw = (val) => `₩ ${new Intl.NumberFormat('ko-KR').format(val)} 원`;
      const formatNum = (val) => new Intl.NumberFormat('ko-KR').format(val);

      if (isLoading) return <div className="flex h-screen items-center justify-center font-black text-2xl text-slate-400">데이터를 불러오는 중입니다...</div>;
      if (loadError) return <div className="flex h-screen items-center justify-center font-black text-2xl text-red-500">data.csv 파일을 찾을 수 없거나 형식이 잘못되었습니다.</div>;

      return (
        <div className="min-h-screen bg-slate-50 p-4 md:p-8 text-slate-900">
          <div className="max-w-7xl mx-auto">
            
            {/* Header & Filter */}
            <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
              <div>
                <h1 className="text-2xl font-black text-slate-900 flex items-center gap-2">
                  <span className="text-blue-600"><Icons.LayoutDashboard /></span>
                  네이버 보보 SA 광고 성과 리포트
                </h1>
                <p className="text-slate-500 text-sm font-bold mt-1">삼성공식파트너 보보 X 광고명가 광고 리포트</p>
              </div>
              
              <div className="flex bg-white p-1 rounded-2xl shadow-sm border border-slate-200 overflow-x-auto whitespace-nowrap scrollbar-hide">
                {categories.map(cat => (
                  <button
                    key={cat}
                    onClick={() => setSelectedCategory(cat)}
                    className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${
                      selectedCategory === cat ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100'
                    }`}
                  >
                    {cat}
                  </button>
                ))}
              </div>
            </div>

            {/* Top 4 KPI Summary */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              
              {/* 1. 소진 광고비 */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 mb-3 text-[#d4a000]">
                  <Icons.Wallet />
                  <span className="text-lg font-black">소진 광고비</span>
                </div>
                <div className="text-2xl font-black text-slate-900">{formatKrw(stats.totalSpend)}</div>
                <div className="mt-2 text-[13px] text-slate-500 font-bold">
                  {selectedCategory === '전체' ? '전체 계정 총 소진 광고비' : `${selectedCategory} 카테고리 소진 광고비`}
                </div>
              </div>
              
              {/* 2. 매출 성과 (ROAS) */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 mb-3 text-green-600">
                  <Icons.TrendingUp />
                  <span className="text-lg font-black">매출 성과 (ROAS)</span>
                </div>
                <div className="text-2xl font-black text-slate-900">{formatKrw(stats.totalRevenue)}</div>
                <div className="mt-2 text-[13px] text-slate-500 font-bold">{stats.roas.toFixed(0)}%</div>
              </div>

              {/* 3. 전환 성과 (CVR) */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 mb-3 text-blue-600">
                  <Icons.Target />
                  <span className="text-lg font-black">전환 성과 (CVR)</span>
                </div>
                <div className="text-2xl font-black text-slate-900">{formatNum(stats.totalConv)}건</div>
                <div className="mt-2 text-[13px] text-slate-500 font-bold">{stats.cvr.toFixed(2)}%</div>
              </div>

              {/* 4. 잔여 예산 (수정: 소진 비율 실시간 연동) */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 mb-3 text-purple-600">
                  <Icons.PieChart />
                  <span className="text-lg font-black">잔여 예산</span>
                </div>
                <div className="text-2xl font-black text-slate-900">
                  {formatKrw(Math.max(0, monthlyBudget - stats.totalSpend))}
                </div>
                <div className="mt-2 text-[13px] text-slate-500 font-bold">
                  소진 비율 : {monthlyBudget > 0 ? ((stats.totalSpend / monthlyBudget) * 100).toFixed(1) : 0}%
                </div>
              </div>
            </div>

            {/* 실제 성과 비교 (ROAS & CVR) */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
              {/* ROAS 현황 */}
              <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                  <h3 className="font-black text-slate-900 text-lg flex items-center gap-2">
                    <span className="text-green-600"><Icons.TrendingUp /></span> 카테고리별 ROAS 현황
                  </h3>
                </div>
                <div className="p-8 space-y-6">
                  {roasData.map((d) => (
                    <div key={d.cat} className="space-y-1.5">
                      <div className="flex justify-between text-sm font-bold">
                        <span className="text-slate-900">{d.cat}</span>
                        <span className="text-green-600">{d.roas.toFixed(0)}%</span>
                      </div>
                      <div className="h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div className="h-full rounded-full bg-green-500" style={{ width: `${(d.roas / maxRoas) * 100}%` }} />
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* CVR 현황 */}
              <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div className="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                  <h3 className="font-black text-slate-900 text-lg flex items-center gap-2">
                    <span className="text-blue-600"><Icons.Target /></span> 카테고리별 전환율(CVR) 현황
                  </h3>
                </div>
                <div className="p-8 space-y-6">
                  {cvrData.map((d) => (
                    <div key={d.cat} className="space-y-1.5">
                      <div className="flex justify-between text-sm font-bold">
                        <span className="text-slate-900">{d.cat}</span>
                        <span className="text-blue-600">{d.cvr.toFixed(2)}%</span>
                      </div>
                      <div className="h-1.5 bg-slate-100 rounded-full overflow-hidden">
                        <div className="h-full rounded-full bg-blue-500" style={{ width: `${(d.cvr / maxCvr) * 100}%` }} />
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* 종합 예산 소진 비율 */}
            <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-8">
              <div className="px-6 py-5 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <h3 className="font-black text-slate-900 text-lg flex items-center gap-2">
                  <span className="text-slate-600"><Icons.Wallet /></span> 종합 예산 소진 비율
                </h3>
                <div className="flex items-center gap-2 bg-slate-50 px-4 py-2 rounded-xl border border-slate-200">
                  <span className="text-sm font-bold text-slate-600">이번 달 총 예산 설정:</span>
                  <input 
                    type="number" 
                    value={monthlyBudget} 
                    onChange={(e) => setMonthlyBudget(Number(e.target.value))}
                    className="border border-slate-300 rounded-lg px-3 py-1 text-sm font-bold w-40 text-right focus:outline-none focus:border-blue-500"
                  />
                  <span className="text-sm font-bold text-slate-600">원</span>
                </div>
              </div>
              <div className="p-8">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  
                  {/* 전체 소진율 카드 (수정: 소진 광고비와 예산 줄바꿈 처리) */}
                  <div className="bg-slate-900 rounded-2xl p-6 text-white col-span-1">
                    <div className="flex justify-between items-start mb-6">
                      <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Total Burn Rate</p>
                        <h4 className="text-2xl font-black">전체 통합 예산</h4>
                      </div>
                      <div className="text-3xl font-black text-blue-400">{totalStats.burnRate.toFixed(1)}%</div>
                    </div>
                    <div className="h-2 bg-white/10 rounded-full overflow-hidden mb-4">
                      <div className="h-full bg-blue-400" style={{ width: `${Math.min(totalStats.burnRate, 100)}%` }} />
                    </div>
                    {/* 줄바꿈 처리 적용 구역 */}
                    <div className="flex flex-col gap-2 text-sm font-bold text-slate-300 mt-2">
                      <span>소진 광고비: {formatKrw(totalStats.spend)}</span>
                      <span>예산: {formatKrw(monthlyBudget)}</span>
                    </div>
                  </div>

                  {/* 카테고리별 예산 소진 비율 */}
                  <div className="col-span-1 lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {categories.filter(c => c !== '전체').map(cat => {
                      const spend = rawData.filter(d => d.category === cat).reduce((a, b) => a + b.spend, 0);
                      const ratio = totalStats.spend > 0 ? (spend / totalStats.spend) * 100 : 0;
                      return (
                        <div key={cat} className="p-4 border border-slate-100 rounded-2xl hover:bg-slate-50 transition-colors">
                          <div className="flex justify-between items-center mb-2">
                            <span className="text-sm font-black text-slate-900">{cat}</span>
                            <span className="text-sm font-bold text-slate-500">소진 비율 {ratio.toFixed(1)}%</span>
                          </div>
                          <div className="h-1.5 bg-slate-100 rounded-full overflow-hidden">
                            <div className="h-full bg-slate-800" style={{ width: `${ratio}%` }} />
                          </div>
                          <div className="mt-3 text-sm text-slate-500 font-bold">소진 광고비: {formatKrw(spend)}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>

            {/* 세부 성과 항목 */}
            <div className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden mb-8">
              <div className="px-8 py-6 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h3 className="font-black text-slate-900 text-lg flex items-center gap-2">
                  <span className="text-blue-600"><Icons.Filter /></span> 세부 성과 항목
                </h3>
                <div className="flex bg-slate-100 p-1 rounded-xl">
                  <button onClick={() => setPivotBy('campaignType')} className={`px-4 py-2 text-sm font-bold rounded-lg transition-all ${pivotBy === 'campaignType' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>광고유형</button>
                  <button onClick={() => setPivotBy('device')} className={`px-4 py-2 text-sm font-bold rounded-lg transition-all ${pivotBy === 'device' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}>디바이스</button>
                </div>
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-slate-50 text-slate-500 text-left font-bold text-sm border-b border-slate-200">
                    <tr>
                      <th className="px-8 py-5">분석 항목</th>
                      <th className="px-8 py-5 text-right">광고비</th>
                      <th className="px-8 py-5 text-right">매출액</th>
                      <th className="px-8 py-5 text-right">ROAS</th>
                      <th className="px-8 py-5 text-right">판매수량</th>
                      <th className="px-8 py-5 text-right text-blue-600">전환 성과 (CVR)</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-50">
                    {pivotData.length > 0 ? pivotData.map((row, idx) => (
                      <tr key={idx} className="hover:bg-slate-50/50 transition-colors">
                        <td className="px-8 py-5 font-black text-slate-900">{row.label}</td>
                        <td className="px-8 py-5 text-right font-bold">{formatKrw(row.spend)}</td>
                        <td className="px-8 py-5 text-right font-black">{formatKrw(row.revenue)}</td>
                        <td className="px-8 py-5 text-right text-green-600 font-black">{row.spend > 0 ? ((row.revenue / row.spend) * 100).toFixed(0) : 0}%</td>
                        <td className="px-8 py-5 text-right font-bold">{formatNum(row.conv)}건</td>
                        <td className="px-8 py-5 text-right font-black text-blue-600">{row.clicks > 0 ? ((row.conv / row.clicks) * 100).toFixed(2) : 0}%</td>
                      </tr>
                    )) : (
                      <tr><td colSpan="6" className="text-center py-10 text-slate-400 font-bold">해당 카테고리에 데이터가 없습니다.</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>